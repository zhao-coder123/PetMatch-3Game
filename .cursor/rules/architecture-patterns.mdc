---
description: 
globs: 
alwaysApply: false
---
# ğŸ—ï¸ æ¶æ„æ¨¡å¼å’Œè®¾è®¡åŸåˆ™

## æ•´ä½“æ¶æ„

### MVVM + Provider æ¶æ„
é¡¹ç›®é‡‡ç”¨ MVVM (Model-View-ViewModel) æ¨¡å¼ç»“åˆ Provider è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼š

```
View (UI) â†â†’ ViewModel (Provider) â†â†’ Model (Data)
    â†“              â†“                    â†“
  Widgets      GameProvider        PetTile/PetType
```

### ç›®å½•ç»“æ„è®¾è®¡
```
lib/
â”œâ”€â”€ main.dart                    # åº”ç”¨å…¥å£ç‚¹
â”œâ”€â”€ models/                      # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ pet_tile.dart           # å® ç‰©æ–¹å—æ¨¡å‹
â”‚   â””â”€â”€ pet_type.dart           # å® ç‰©ç±»å‹æšä¸¾
â”œâ”€â”€ providers/                   # ä¸šåŠ¡é€»è¾‘å±‚ (ViewModel)
â”‚   â””â”€â”€ game_provider.dart      # æ¸¸æˆçŠ¶æ€ç®¡ç†
â””â”€â”€ widgets/                     # UIç»„ä»¶å±‚ (View)
    â”œâ”€â”€ game_grid.dart          # æ¸¸æˆç½‘æ ¼å®¹å™¨
    â”œâ”€â”€ game_info_panel.dart    # ä¿¡æ¯é¢æ¿
    â”œâ”€â”€ pet_tile_widget.dart    # å® ç‰©æ–¹å—ç»„ä»¶
    â””â”€â”€ game_over_dialog.dart   # æ¸¸æˆç»“æŸå¯¹è¯æ¡†
```

## è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. Provider æ¨¡å¼ (çŠ¶æ€ç®¡ç†)
æ ¸å¿ƒå®ç°åœ¨ [lib/providers/game_provider.dart](mdc:lib/providers/game_provider.dart)ï¼š

```dart
class GameProvider extends ChangeNotifier {
  // ç§æœ‰çŠ¶æ€
  List<List<PetTile?>> _grid = [];
  int _score = 0;
  
  // å…¬å¼€æ¥å£
  int get score => _score;
  List<List<PetTile?>> get grid => _grid;
  
  // çŠ¶æ€å˜æ›´æ–¹æ³•
  void updateScore(int points) {
    _score += points;
    notifyListeners(); // é€šçŸ¥ç›‘å¬è€…
  }
}
```

#### ä½¿ç”¨åŸåˆ™ï¼š
- å•ä¸€è´£ä»»ï¼šæ¯ä¸ªProvideråªç®¡ç†ç‰¹å®šä¸šåŠ¡é¢†åŸŸ
- ä¸å¯å˜æš´éœ²ï¼šé€šè¿‡getteræš´éœ²çŠ¶æ€ï¼Œä¿æŠ¤å†…éƒ¨æ•°æ®
- ç²¾ç¡®é€šçŸ¥ï¼šåªåœ¨å¿…è¦æ—¶è°ƒç”¨ notifyListeners()

### 2. è§‚å¯Ÿè€…æ¨¡å¼ (UIå“åº”)
åœ¨UIç»„ä»¶ä¸­ä½¿ç”¨ Consumer æˆ– Selector ç›‘å¬çŠ¶æ€å˜åŒ–ï¼š

```dart
// Consumer - ç›‘å¬æ•´ä¸ªProvider
Consumer<GameProvider>(
  builder: (context, gameProvider, child) {
    return Text('åˆ†æ•°: ${gameProvider.score}');
  },
)

// Selector - ç›‘å¬ç‰¹å®šå±æ€§
Selector<GameProvider, int>(
  selector: (context, provider) => provider.score,
  builder: (context, score, child) {
    return Text('åˆ†æ•°: $score');
  },
)
```

### 3. å¯¹è±¡æ± æ¨¡å¼ (æ€§èƒ½ä¼˜åŒ–)
åœ¨ [lib/main.dart](mdc:lib/main.dart) çš„ ParticleManager ä¸­å®ç°ï¼š

```dart
class ParticleManager {
  static final Queue<Particle> _particlePool = Queue<Particle>();
  
  static Particle acquire() {
    if (_particlePool.isNotEmpty) {
      return _particlePool.removeFirst()..reset();
    }
    return Particle();
  }
  
  static void release(Particle particle) {
    _particlePool.add(particle);
  }
}
```

### 4. ç­–ç•¥æ¨¡å¼ (åŒ¹é…ç®—æ³•)
ä¸åŒçš„åŒ¹é…æ£€æµ‹ç­–ç•¥ï¼š

```dart
abstract class MatchStrategy {
  List<PetTile> findMatches(List<List<PetTile?>> grid);
}

class HorizontalMatchStrategy implements MatchStrategy {
  @override
  List<PetTile> findMatches(List<List<PetTile?>> grid) {
    // æ°´å¹³åŒ¹é…é€»è¾‘
  }
}

class VerticalMatchStrategy implements MatchStrategy {
  @override
  List<PetTile> findMatches(List<List<PetTile?>> grid) {
    // å‚ç›´åŒ¹é…é€»è¾‘
  }
}
```

### 5. å‘½ä»¤æ¨¡å¼ (æ¸¸æˆæ“ä½œ)
å°†æ¸¸æˆæ“ä½œå°è£…ä¸ºå‘½ä»¤ï¼š

```dart
abstract class GameCommand {
  Future<void> execute();
  Future<void> undo();
}

class SwapTilesCommand implements GameCommand {
  final int fromRow, fromCol, toRow, toCol;
  final GameProvider provider;
  
  SwapTilesCommand(this.provider, this.fromRow, this.fromCol, this.toRow, this.toCol);
  
  @override
  Future<void> execute() async {
    await provider.swapTiles(fromRow, fromCol, toRow, toCol);
  }
  
  @override
  Future<void> undo() async {
    await provider.swapTiles(toRow, toCol, fromRow, fromCol);
  }
}
```

## ç»„ä»¶è®¾è®¡åŸåˆ™

### 1. å•ä¸€è´£ä»»åŸåˆ™
æ¯ä¸ªWidgetéƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼š

- [lib/widgets/pet_tile_widget.dart](mdc:lib/widgets/pet_tile_widget.dart) - åªè´Ÿè´£å•ä¸ªå® ç‰©æ–¹å—çš„æ¸²æŸ“å’ŒåŠ¨ç”»
- [lib/widgets/game_grid.dart](mdc:lib/widgets/game_grid.dart) - åªè´Ÿè´£ç½‘æ ¼å¸ƒå±€å’Œäº¤äº’
- [lib/widgets/game_info_panel.dart](mdc:lib/widgets/game_info_panel.dart) - åªè´Ÿè´£ä¿¡æ¯æ˜¾ç¤º

### 2. ä¾èµ–å€’ç½®åŸåˆ™
é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œéƒ½ä¾èµ–æŠ½è±¡ï¼š

```dart
// âŒ é”™è¯¯ï¼šç›´æ¥ä¾èµ–å…·ä½“å®ç°
class GameScreen {
  final GameProvider gameProvider = GameProvider();
}

// âœ… æ­£ç¡®ï¼šä¾èµ–æ³¨å…¥
class GameScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider(
      create: (_) => GameProvider(),
      child: _buildGame(),
    );
  }
}
```

### 3. å¼€é—­åŸåˆ™
å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼š

```dart
// åŸºç¡€åŠ¨ç”»ç»„ä»¶
abstract class AnimatedWidget extends StatefulWidget {
  final Duration duration;
  final Curve curve;
  
  const AnimatedWidget({
    required this.duration,
    this.curve = Curves.easeInOut,
  });
}

// æ‰©å±•ï¼šå® ç‰©æ–¹å—åŠ¨ç”»
class AnimatedPetTileWidget extends AnimatedWidget {
  final PetTile tile;
  
  const AnimatedPetTileWidget({
    required this.tile,
    super.duration = const Duration(milliseconds: 300),
    super.curve,
  });
}
```

## çŠ¶æ€ç®¡ç†æ¨¡å¼

### åˆ†å±‚çŠ¶æ€ç®¡ç†
```
UI Layer (Widgets)
     â†“ Consumer/Selector
ViewModel Layer (Providers)
     â†“ Business Logic
Model Layer (Data Objects)
```

### çŠ¶æ€æµå‘
1. **ç”¨æˆ·æ“ä½œ** â†’ UI Widget æ¥æ”¶äº‹ä»¶
2. **äº‹ä»¶å¤„ç†** â†’ è°ƒç”¨ Provider æ–¹æ³•
3. **çŠ¶æ€æ›´æ–°** â†’ Provider ä¿®æ”¹å†…éƒ¨çŠ¶æ€
4. **é€šçŸ¥æœºåˆ¶** â†’ notifyListeners() é€šçŸ¥è®¢é˜…è€…
5. **UIé‡å»º** â†’ Consumer é‡å»ºç›¸å…³Widget

### å¼‚æ­¥çŠ¶æ€å¤„ç†
åœ¨ [lib/providers/game_provider.dart](mdc:lib/providers/game_provider.dart) ä¸­çš„å¼‚æ­¥æ“ä½œæ¨¡å¼ï¼š

```dart
class GameProvider extends ChangeNotifier {
  bool _isProcessingMatch = false;
  
  Future<void> swapTiles(int row1, int col1, int row2, int col2) async {
    // é˜²æ­¢å¹¶å‘æ“ä½œ
    if (_isProcessingMatch) return;
    
    try {
      _isProcessingMatch = true;
      
      // æ‰§è¡Œäº¤æ¢
      await _performSwap(row1, col1, row2, col2);
      
      // å¤„ç†åŒ¹é…
      await _processMatches();
      
    } finally {
      _isProcessingMatch = false;
    }
  }
}
```

## é”™è¯¯å¤„ç†æ¶æ„

### åˆ†å±‚é”™è¯¯å¤„ç†
1. **UIå±‚**: æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
2. **Providerå±‚**: ä¸šåŠ¡é€»è¾‘é”™è¯¯å¤„ç†å’Œæ¢å¤
3. **Modelå±‚**: æ•°æ®éªŒè¯å’Œè¾¹ç•Œæ£€æŸ¥

### é”™è¯¯æ¢å¤æœºåˆ¶
```dart
class GameProvider extends ChangeNotifier {
  void _handleError(Object error, StackTrace stackTrace) {
    debugPrint('æ¸¸æˆé”™è¯¯: $error');
    
    // é”™è¯¯æ¢å¤é€»è¾‘
    _resetToSafeState();
    
    // é€šçŸ¥UIæ˜¾ç¤ºé”™è¯¯
    _errorMessage = 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
    notifyListeners();
  }
  
  void _resetToSafeState() {
    _isProcessingMatch = false;
    _selectedTile = null;
    // å…¶ä»–å®‰å…¨çŠ¶æ€é‡ç½®
  }
}
```

## æ€§èƒ½ä¼˜åŒ–æ¶æ„

### æ¸²æŸ“ä¼˜åŒ–
1. **RepaintBoundary**: éš”ç¦»é‡ç»˜åŒºåŸŸ
2. **constæ„é€ å‡½æ•°**: å‡å°‘ä¸å¿…è¦çš„é‡å»º
3. **Selector**: ç²¾ç¡®ç›‘å¬çŠ¶æ€å˜åŒ–

### å†…å­˜ç®¡ç†
1. **å¯¹è±¡æ± **: é‡ç”¨é¢‘ç¹åˆ›å»ºçš„å¯¹è±¡
2. **èµ„æºé‡Šæ”¾**: åŠæ—¶disposeèµ„æº
3. **å¼±å¼•ç”¨**: é¿å…å¾ªç¯å¼•ç”¨

### åŠ¨ç”»ä¼˜åŒ–
1. **Controllerå¤ç”¨**: é¿å…é¢‘ç¹åˆ›å»ºåŠ¨ç”»æ§åˆ¶å™¨
2. **ç¡¬ä»¶åŠ é€Ÿ**: ä½¿ç”¨Transformè€Œéå¸ƒå±€å˜åŒ–
3. **æ‰¹é‡æ“ä½œ**: å°†å¤šä¸ªçŠ¶æ€æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡é€šçŸ¥

## æµ‹è¯•æ¶æ„

### æµ‹è¯•åˆ†å±‚
```
E2E Tests (é›†æˆæµ‹è¯•)
    â†“
Widget Tests (ç»„ä»¶æµ‹è¯•)
    â†“  
Unit Tests (å•å…ƒæµ‹è¯•)
```

### å¯æµ‹è¯•æ€§è®¾è®¡
1. **ä¾èµ–æ³¨å…¥**: ä¾¿äºMockä¾èµ–
2. **çº¯å‡½æ•°**: æ–¹ä¾¿å•å…ƒæµ‹è¯•
3. **çŠ¶æ€éš”ç¦»**: Providerç‹¬ç«‹å¯æµ‹è¯•

```dart
// å¯æµ‹è¯•çš„Providerè®¾è®¡
class GameProvider extends ChangeNotifier {
  GameProvider({
    this.random = const RandomGenerator(),
    this.timer = const TimerService(),
  });
  
  final RandomGenerator random;
  final TimerService timer;
  
  // ä¸šåŠ¡é€»è¾‘æ–¹æ³•éƒ½æ˜¯çº¯å‡½æ•°æˆ–æ˜“äºæµ‹è¯•
}
```

