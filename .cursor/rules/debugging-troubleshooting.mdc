---
description:
globs:
alwaysApply: false
---
# ğŸ”§ è°ƒè¯•å’Œæ•…éšœæ’é™¤æŒ‡å—

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. å†…å­˜æ³„æ¼é—®é¢˜

#### ç—‡çŠ¶
- åº”ç”¨è¿è¡Œä¸€æ®µæ—¶é—´åå˜æ…¢
- å†…å­˜ä½¿ç”¨é‡æŒç»­å¢é•¿
- åŠ¨ç”»å¡é¡¿æˆ–æ‰å¸§

#### æ£€æŸ¥ç‚¹
å‚è€ƒ [lib/main.dart](mdc:lib/main.dart) ä¸­å·²ä¿®å¤çš„å†…å­˜æ³„æ¼ï¼š

```dart
// âŒ é—®é¢˜ä»£ç ï¼šé™æ€å˜é‡å¯¼è‡´å†…å­˜æ³„æ¼
class ParticlePainter extends CustomPainter {
  static final List<Particle> particles = []; // æ°¸ä¸é‡Šæ”¾
}

// âœ… ä¿®å¤ä»£ç ï¼šä½¿ç”¨å¯¹è±¡æ± ç®¡ç†
class ParticleManager {
  static final Queue<Particle> _particlePool = Queue<Particle>();
  
  static void cleanupParticles() {
    _particlePool.clear(); // å¯ä»¥æ¸…ç†
  }
}
```

#### è°ƒè¯•æ–¹æ³•
1. ä½¿ç”¨ Flutter Inspector æŸ¥çœ‹Widgetæ ‘
2. å¼€å¯å†…å­˜åˆ†æï¼š`flutter run --profile`
3. æ£€æŸ¥åŠ¨ç”»æ§åˆ¶å™¨æ˜¯å¦æ­£ç¡®dispose

### 2. å¼‚æ­¥ç«æ€æ¡ä»¶

#### ç—‡çŠ¶
- ç”¨æˆ·å¿«é€Ÿç‚¹å‡»æ—¶åº”ç”¨å´©æºƒ
- çŠ¶æ€ä¸ä¸€è‡´é”™è¯¯
- åŠ¨ç”»å¼‚å¸¸ä¸­æ–­

#### é—®é¢˜æ ¹æº
å‚è€ƒ [lib/providers/game_provider.dart](mdc:lib/providers/game_provider.dart) ä¸­çš„ä¿®å¤ï¼š

```dart
// âŒ é—®é¢˜ä»£ç ï¼šåµŒå¥—å›è°ƒå®¹æ˜“äº§ç”Ÿç«æ€
void swapTiles(int row1, int col1, int row2, int col2) {
  _animateSwap().then((_) {
    _checkMatches().then((_) {
      _processMatches(); // å¯èƒ½é‡å¤æ‰§è¡Œ
    });
  });
}

// âœ… ä¿®å¤ä»£ç ï¼šä½¿ç”¨é”æœºåˆ¶å’Œasync/await
bool _isProcessingMatch = false;

Future<void> swapTiles(int row1, int col1, int row2, int col2) async {
  if (_isProcessingMatch) return; // é˜²æ­¢å¹¶å‘
  
  try {
    _isProcessingMatch = true;
    await _animateSwap();
    await _checkMatches();
    await _processMatches();
  } finally {
    _isProcessingMatch = false;
  }
}
```

#### è°ƒè¯•æŠ€å·§
1. æ·»åŠ æ—¥å¿—è®°å½•æ“ä½œæµç¨‹
2. ä½¿ç”¨æ–­ç‚¹æ£€æŸ¥å¼‚æ­¥æ“ä½œé¡ºåº
3. å®ç°æ“ä½œé”é˜²æ­¢å¹¶å‘

### 3. æ— é™é€’å½’é—®é¢˜

#### ç—‡çŠ¶
- åº”ç”¨çªç„¶å´©æºƒ
- Stack overflow é”™è¯¯
- è¿å‡»æ•ˆæœæ— æ³•åœæ­¢

#### è§£å†³æ–¹æ¡ˆ
åœ¨ [lib/providers/game_provider.dart](mdc:lib/providers/game_provider.dart) ä¸­æ·»åŠ é€’å½’æ·±åº¦æ§åˆ¶ï¼š

```dart
// âœ… ä¿®å¤ä»£ç ï¼šæ·»åŠ é€’å½’æ·±åº¦æ§åˆ¶
Future<void> _processMatches({int depth = 0}) async {
  const maxDepth = 10; // æœ€å¤§é€’å½’æ·±åº¦
  
  if (depth >= maxDepth) {
    debugPrint('âš ï¸ è¾¾åˆ°æœ€å¤§é€’å½’æ·±åº¦ï¼Œåœæ­¢å¤„ç†');
    return;
  }
  
  final matches = _findMatches();
  if (matches.isEmpty) return;
  
  // å¤„ç†å½“å‰åŒ¹é…
  await _animateAndRemoveMatches(matches);
  
  // é€’å½’å¤„ç†æ–°çš„åŒ¹é…ï¼ˆå¢åŠ æ·±åº¦ï¼‰
  await _processMatches(depth: depth + 1);
}
```

### 4. Widgeté‡å»ºæ€§èƒ½é—®é¢˜

#### ç—‡çŠ¶
- UIå“åº”ç¼“æ…¢
- æ»šåŠ¨ä¸æµç•…
- åŠ¨ç”»æ‰å¸§

#### ä¼˜åŒ–ç­–ç•¥
å‚è€ƒ [lib/widgets/game_grid.dart](mdc:lib/widgets/game_grid.dart) çš„æœ€ä½³å®è·µï¼š

```dart
// âœ… ä½¿ç”¨ const æ„é€ å‡½æ•°
class GameTile extends StatelessWidget {
  const GameTile({
    super.key,
    required this.tile,
    required this.onTap,
  });
}

// âœ… ä½¿ç”¨ RepaintBoundary éš”ç¦»é‡ç»˜
Widget _buildGameGrid() {
  return RepaintBoundary(
    child: GridView.builder(
      itemBuilder: (context, index) {
        return const GameTile(...);
      },
    ),
  );
}

// âœ… ä½¿ç”¨ Selector ç²¾ç¡®ç›‘å¬
Selector<GameProvider, PetTile?>(
  selector: (context, provider) => provider.getTileAt(row, col),
  builder: (context, tile, child) {
    return GameTile(tile: tile);
  },
)
```

## è°ƒè¯•å·¥å…·å’ŒæŠ€å·§

### 1. Flutter Inspector
```bash
# å¯åŠ¨åº”ç”¨å¹¶æ‰“å¼€Inspector
flutter run
# åœ¨IDEä¸­æ‰“å¼€ Flutter Inspector é¢æ¿
```

#### ä½¿ç”¨è¦ç‚¹
- æŸ¥çœ‹Widgetæ ‘ç»“æ„
- æ£€æŸ¥çŠ¶æ€å˜åŒ–
- åˆ†æé‡å»ºé¢‘ç‡
- å®šä½å†…å­˜æ³„æ¼

### 2. æ€§èƒ½åˆ†æ
```bash
# æ€§èƒ½æ¨¡å¼è¿è¡Œ
flutter run --profile

# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
flutter run --profile --trace-startup
```

### 3. è°ƒè¯•è¾“å‡º
åœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼š

```dart
class GameProvider extends ChangeNotifier {
  Future<void> swapTiles(int row1, int col1, int row2, int col2) async {
    debugPrint('ğŸ¯ å¼€å§‹äº¤æ¢æ–¹å—: ($row1,$col1) â†” ($row2,$col2)');
    
    if (_isProcessingMatch) {
      debugPrint('âš ï¸ æ­£åœ¨å¤„ç†åŒ¹é…ï¼Œå¿½ç•¥æ“ä½œ');
      return;
    }
    
    try {
      _isProcessingMatch = true;
      debugPrint('ğŸ”„ è®¾ç½®å¤„ç†é”');
      
      // ä¸šåŠ¡é€»è¾‘...
      
    } catch (e, stackTrace) {
      debugPrint('âŒ äº¤æ¢æ–¹å—é”™è¯¯: $e');
      debugPrint('ğŸ“Š å †æ ˆè·Ÿè¸ª: $stackTrace');
    } finally {
      _isProcessingMatch = false;
      debugPrint('ğŸ”“ é‡Šæ”¾å¤„ç†é”');
    }
  }
}
```

### 4. æ–­è¨€å’ŒéªŒè¯
```dart
class GameProvider extends ChangeNotifier {
  void _swapTilesInGrid(int row1, int col1, int row2, int col2) {
    // æ·»åŠ è¾¹ç•Œæ£€æŸ¥æ–­è¨€
    assert(row1 >= 0 && row1 < gridSize, 'è¡Œ1è¶…å‡ºè¾¹ç•Œ: $row1');
    assert(col1 >= 0 && col1 < gridSize, 'åˆ—1è¶…å‡ºè¾¹ç•Œ: $col1');
    assert(row2 >= 0 && row2 < gridSize, 'è¡Œ2è¶…å‡ºè¾¹ç•Œ: $row2');
    assert(col2 >= 0 && col2 < gridSize, 'åˆ—2è¶…å‡ºè¾¹ç•Œ: $col2');
    
    // æ‰§è¡Œäº¤æ¢
    final temp = _grid[row1][col1];
    _grid[row1][col1] = _grid[row2][col2];
    _grid[row2][col2] = temp;
  }
}
```

## é”™è¯¯å¤„ç†æ¨¡å¼

### 1. åˆ†å±‚é”™è¯¯æ•è·
```dart
class GameProvider extends ChangeNotifier {
  String? _errorMessage;
  String? get errorMessage => _errorMessage;
  
  void _handleError(Object error, StackTrace stackTrace) {
    // è®°å½•é”™è¯¯
    debugPrint('ğŸš¨ æ¸¸æˆé”™è¯¯: $error');
    debugPrint('ğŸ“‹ å †æ ˆ: $stackTrace');
    
    // è®¾ç½®ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    _errorMessage = _getUserFriendlyErrorMessage(error);
    
    // é‡ç½®åˆ°å®‰å…¨çŠ¶æ€
    _resetToSafeState();
    
    // é€šçŸ¥UI
    notifyListeners();
  }
  
  String _getUserFriendlyErrorMessage(Object error) {
    if (error is RangeError) {
      return 'æ¸¸æˆæ•°æ®å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨ä¿®å¤';
    } else if (error is StateError) {
      return 'æ“ä½œå¤ªå¿«äº†ï¼Œè¯·ç¨åå†è¯•';
    }
    return 'å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œæ¸¸æˆå·²é‡ç½®';
  }
  
  void _resetToSafeState() {
    _isProcessingMatch = false;
    _selectedTile = null;
    _errorMessage = null;
  }
}
```

### 2. UIé”™è¯¯æ˜¾ç¤º
```dart
class GameScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Consumer<GameProvider>(
        builder: (context, gameProvider, child) {
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          if (gameProvider.errorMessage != null) {
            WidgetsBinding.instance.addPostFrameCallback((_) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(gameProvider.errorMessage!),
                  backgroundColor: Colors.red,
                ),
              );
            });
          }
          
          return _buildGameContent();
        },
      ),
    );
  }
}
```

## æµ‹è¯•å’ŒéªŒè¯

### 1. å•å…ƒæµ‹è¯•ç¤ºä¾‹
å‚è€ƒ [test/](mdc:test/) ç›®å½•ï¼š

```dart
group('GameProvider æµ‹è¯•', () {
  late GameProvider gameProvider;
  
  setUp(() {
    gameProvider = GameProvider();
  });
  
  test('åº”è¯¥æ­£ç¡®å¤„ç†æ–¹å—äº¤æ¢', () async {
    // è®¾ç½®åˆå§‹çŠ¶æ€
    gameProvider.initializeGrid();
    
    // æ‰§è¡Œæ“ä½œ
    await gameProvider.swapTiles(0, 0, 0, 1);
    
    // éªŒè¯ç»“æœ
    expect(gameProvider.isProcessingMatch, false);
    expect(gameProvider.errorMessage, null);
  });
  
  test('åº”è¯¥é˜²æ­¢å¹¶å‘æ“ä½œ', () async {
    gameProvider.initializeGrid();
    
    // åŒæ—¶æ‰§è¡Œå¤šä¸ªæ“ä½œ
    final futures = [
      gameProvider.swapTiles(0, 0, 0, 1),
      gameProvider.swapTiles(1, 0, 1, 1),
    ];
    
    await Future.wait(futures);
    
    // éªŒè¯åªæœ‰ä¸€ä¸ªæ“ä½œè¢«æ‰§è¡Œ
    expect(gameProvider.isProcessingMatch, false);
  });
});
```

### 2. Widgetæµ‹è¯•
```dart
testWidgets('æ¸¸æˆç½‘æ ¼åº”è¯¥æ­£ç¡®æ˜¾ç¤º', (WidgetTester tester) async {
  await tester.pumpWidget(
    MaterialApp(
      home: ChangeNotifierProvider(
        create: (_) => GameProvider(),
        child: GameScreen(),
      ),
    ),
  );
  
  // éªŒè¯UIæ¸²æŸ“
  expect(find.byType(GridView), findsOneWidget);
  expect(find.byType(GameTile), findsWidgets);
  
  // æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’
  await tester.tap(find.byType(GameTile).first);
  await tester.pump();
  
  // éªŒè¯çŠ¶æ€å˜åŒ–
  expect(find.text('é€‰ä¸­'), findsOneWidget);
});
```

## æ€§èƒ½ç›‘æ§

### 1. è¿è¡Œæ—¶æ€§èƒ½ç›‘æ§
```dart
class PerformanceMonitor {
  static final Stopwatch _stopwatch = Stopwatch();
  
  static void startTimer(String operation) {
    debugPrint('â±ï¸ å¼€å§‹: $operation');
    _stopwatch.start();
  }
  
  static void stopTimer(String operation) {
    _stopwatch.stop();
    final elapsed = _stopwatch.elapsedMilliseconds;
    debugPrint('â±ï¸ å®Œæˆ: $operation (${elapsed}ms)');
    
    if (elapsed > 16) { // è¶…è¿‡ä¸€å¸§æ—¶é—´
      debugPrint('âš ï¸ æ€§èƒ½è­¦å‘Š: $operation è€—æ—¶è¿‡é•¿');
    }
    
    _stopwatch.reset();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
Future<void> _processMatches() async {
  PerformanceMonitor.startTimer('å¤„ç†åŒ¹é…');
  
  // ä¸šåŠ¡é€»è¾‘...
  
  PerformanceMonitor.stopTimer('å¤„ç†åŒ¹é…');
}
```

### 2. å†…å­˜ä½¿ç”¨ç›‘æ§
```dart
class MemoryMonitor {
  static void logMemoryUsage(String context) {
    final info = ProcessInfo.currentRss;
    debugPrint('ğŸ’¾ å†…å­˜ä½¿ç”¨ [$context]: ${info / 1024 / 1024:.1f}MB');
  }
}
```

## å‘å¸ƒå‰æ£€æŸ¥æ¸…å•

### ä»£ç è´¨é‡
- [ ] æ‰€æœ‰ TODO å’Œ FIXME å·²å¤„ç†
- [ ] ç§»é™¤è°ƒè¯•è¾“å‡ºå’Œæµ‹è¯•ä»£ç 
- [ ] ç¡®ä¿æ‰€æœ‰èµ„æºæ­£ç¡®é‡Šæ”¾
- [ ] å¼‚å¸¸å¤„ç†å®Œæ•´

### æ€§èƒ½éªŒè¯
- [ ] å¯åŠ¨æ—¶é—´ < 3ç§’
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®š
- [ ] åŠ¨ç”»æµç•…(60fps)
- [ ] æ— å†…å­˜æ³„æ¼

### åŠŸèƒ½æµ‹è¯•
- [ ] æ‰€æœ‰æ¸¸æˆåŠŸèƒ½æ­£å¸¸
- [ ] å¤šç§è®¾å¤‡å°ºå¯¸é€‚é…
- [ ] å¼‚å¸¸æƒ…å†µå¤„ç†æ­£ç¡®
- [ ] ç”¨æˆ·ä½“éªŒæµç•…
